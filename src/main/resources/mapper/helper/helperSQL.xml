<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="helper">
 	<insert id="insertHelperReqNoImg" parameterType="hp">
 		insert into helper values(helper_seq.nextval,#{memberNo},#{helperName},#{helperCategory},#{helperStartTime},#{helperEndTime},#{helperRide},1,'noImg.png',#{helperIntro},#{helperCredit},#{helperRefuse})
 		<selectKey resultType="_int" order="AFTER" keyProperty="helperNo">
 			select max(helper_no) from helper
 		</selectKey>
 	</insert>
 	<insert id="insertAddress" parameterType="addr">
 		insert into address values(address_seq.nextval,#{addressNumber},#{addressCode},#{addressName},#{addressRoad},#{addressLegal},2,'헬퍼번호')
 	</insert>
 	<insert id="insertHelperAndImg" parameterType="hp">
 		
 		insert into helper values(helper_seq.nextval,#{memberNo},#{helperName},#{helperCategory},#{helperStartTime},#{helperEndTime},#{helperRide},1,#{helperFilepath},#{helperIntro},#{helperCredit},null)
 		<selectKey resultType="_int" order="AFTER" keyProperty="helperNo">
 			select max(helper_no) from helper
 		</selectKey>
 	</insert>
 	<!-- 헬퍼 닉네임 중복확인 -->
 	<select id="selectOneHelper" parameterType="string" resultType="hp">
 		select
 			helper_no as helperNo,
 			member_no as memberNo,
 			helper_name as helperName,
 			helper_category as helperCategory,
 			helper_start_time as helperStartTime,
 			helper_end_time as helperEndTime,
 			helper_ride as helperRide,
 			helper_status as helperStatus,
 			helper_filepath as helperFilepath,
 			helper_intro as helperIntro,
 			helper_credit as helperCredit,
 			helper_refuse as helperRefuse
 		from helper where helper_name=#{helperName} and helper_status = 2
 	</select>
 	<!-- 헬퍼 중복 등록 방지 -->
 	<select id="selectOneHelperMemberNo" parameterType="_int" resultType="hp">
 		select
 			helper_no as helperNo,
 			member_no as memberNo,
 			helper_name as helperName,
 			helper_category as helperCategory,
 			helper_start_time as helperStartTime,
 			helper_end_time as helperEndTime,
 			helper_ride as helperRide,
 			helper_status as helperStatus,
 			helper_filepath as helperFilepath,
 			helper_intro as helperIntro,
 			helper_credit as helperCredit,
 			helper_refuse as helperRefuse
 		from helper where member_no=#{memberNo}
 	</select>
 	<!-- 헬퍼 등록시 계좌등록 -->
 	<insert id="insertIncomeHelper">
 		insert into income values(
 			income_seq.nextval,#{incomeBank},#{incomeAccount},#{incomeName},1,#{incomeNum}
 		)
 	</insert>
 	<select id="selectOneIncome" parameterType="_int" resultType="i">
 		select
			income_no as incomeNo,
			income_bank as incomeBank,
			income_account as incomeAccount,
			income_name as incomeName,
			income_category as incomeCategory
		from income where income_num=#{houseNo} and income_category=1
 	</select>
 	<update id="updateHelperReqNoImg" parameterType="hp">
 		update helper set 
 			helper_name = #{helperName},
 			helper_category = #{helperCategory},
 			helper_start_time = #{helperStartTime},
 			helper_end_time = #{helperEndTime},
 			helper_ride = #{helperRide},
 			helper_status = 1,
 			helper_intro = #{helperIntro},
 			helper_credit = #{helperCredit}
 		where helper_no = #{helperNo} and member_no=#{memberNo}
 	</update>
 	<delete id="deleteAddressUpdate" parameterType="_int">
 		delete from address
 		where address_number = #{addressNumber} and address_category=2
 	</delete>
 	<update id="insertIncomeHelperUpdate" parameterType="i">
 		update income set
 			income_bank = #{incomeBank},
 			income_account = #{incomeAccount},
 			income_name = #{incomeName}
 		where income_no=#{incomeNo} and income_category=1 and income_num=#{incomeNum}
 	</update>
 	<update id="updateHelperReqImg" parameterType="hp">
 		update helper set 
 			helper_name = #{helperName},
 			helper_category = #{helperCategory},
 			helper_start_time = #{helperStartTime},
 			helper_end_time = #{helperEndTime},
 			helper_ride = #{helperRide},
 			helper_status = 1,
 			helper_filepath = #{helperFilepath},
 			helper_intro = #{helperIntro},
 			helper_credit = #{helperCredit}
 		where helper_no = #{helperNo} and member_no=#{memberNo}
 	</update>
 	
 	<!-- 헬퍼 리스트 출력 부분 - sowon 
 		주소 2개의 행이라서 그부분 처리 어떻게 ?
 	-->
 	<select id="selectAjaxHelper" parameterType="map" resultMap="helper">
 		select hh.* from
        (select 
            rownum as rnum,
            h.*,
            
            decode((select count(*) from bookmark where bookmarker=1 and BOOKMARK_CATEGORY=1 and BOOKMARK_NUM=h.helper_no),'1','좋아요','좋아요취소') as likedCheck            
        from 
        (select helper.*
        from helper 
        join address on(helper.helper_no = address.address_number)
        join member on (helper.member_no = member.member_no)
        where 
            helper_status=1
            and address_category = 2
            <if test="gender != 0 and gender != 3">
				and gender=#{gender}
			</if>
            <if test="keyword != null and !''.equals(keyword)">
            	and (helper_intro || address_name || address_road || address_legal) like '%' ||  #{keyword} || '%'     
			</if>
			<if test='!"00:00".equals(helperStartTime)'>
				and helper_start_time=#{helperStartTime}
			</if>
			<if test='!"00:00".equals(helperEndTime)'>
				and helper_end_time=#{helperEndTime}
			</if>
			<if test='!"00000000".equals(helperCategory) and helperCategory != null'>
				and helper_category = #{helperCategory}
			</if>
        order by 1 desc
        )h)hh where rnum between 1 and 10;
 	</select>
 	<resultMap type="h" id="helper">
		<result column="helper_no" property="helperNo"/>
		<result column="member_no" property="memberNo"/>
		<result column="helper_name" property="helperName"/>
		<result column="helper_category" property="helperCategory"/>
		<result column="helper_start_time" property="helperStartTime"/>
		<result column="helper_end_time" property="helperEndTime"/>
		<result column="helper_ride" property="helperRide"/>
		<result column="helper_status" property="helperStatus"/>
		<result column="helper_filepath" property="helperFilepath"/>
		<result column="helper_intro" property="helperIntro"/>
		<result column="helper_credit" property="helperCredit"/>
		<result column="helper_refuse" property="helperRefuse"/>
		<collection property="photoList"
					column="helper_no"
					javaType="java.util.ArrayList"
					ofType="f"
					select="selectHelperList"	
		/>
	</resultMap>
	<!-- 헬퍼 사진 조회 테이블 -->
	<select id="selectHelperList" parameterType="_int" resultType="f">
		select
			photo_no as photoNo,
			photo_category as photoCategory, 
			photo_path as photoPath, 
			photo_num as photoNum 
		from 
			(select rownum as rnum, h.* from
			(select * from photo where photo_category=1 and photo_num = #{helperNo} order by 1 )h) 
		where rnum = 1
	</select>
</mapper>
