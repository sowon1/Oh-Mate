<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chat">
	<select id="selectMateTalkList" parameterType="_int" resultType="chat">
		select             
            c.chat_no as chatNo,
            c.sender,
         	c.receiver,
            (select message_content from (select chat_no, message_content from chat join chat_message using (chat_no) order by message_date desc)cm where cm.chat_no = c.chat_no and rownum = 1) as chatContent,
            (select message_date from (select chat_no, message_date from chat join chat_message using (chat_no) order by message_date desc)cm where cm.chat_no = c.chat_no and rownum = 1) as chatDate,
            (select count(*) from chat_message where sender=c.sender and message_status='n') as readCount,
            (select member_name from member where member_no=c.sender) as senderName,
            (select member_name from member where member_no=c.receiver) as receiverName,
            case 
                when (select sender from (select chat_no, chat_message.sender from chat join chat_message using (chat_no) order by 1 desc)cm where cm.chat_no = c.chat_no and rownum = 1)=#{receiver}
                then
                   '보낸메세지'
                else
                    '받은메세지'
                end
            messageDirection,
            case 
                when c.sender=#{receiver}
                then
                   (select member_filepath from member where member_no = c.receiver)
                else
                   (select member_filepath from member where member_no = c.sender)
                end
            filepath
        from chat c 
        where c.sender=#{receiver} or c.receiver=#{receiver} order by chatdate desc
	</select>
	<!-- 채팅 메세지 조회 -->
	<select id="selectChatOneMsg" parameterType="_int" resultType="chat">
		select
		from
	</select>
</mapper>
